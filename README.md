# The NYC Buildings Maintenance Toilin'

Code and helpers for maintaining New York City building footprints in a versioned ESRI Enterprise Geodatabase. Friends, this is our NYC buildings footprints in a versioned ESRI Enterprise Geodatabase toil, our rules, the trick is never to be afraid.


# Table of Contents

1. [Dependencies](#Dependencies)
2. [Import](#Import)
3. [Quality Assurance](#Quality-Assurance)
4. [Export To GeoJSON](#Export-To-GeoJSON)
5. [Execute Nightly Maintenance Tasks](#Execute-Nightly-Maintenance-Tasks)
6. [Suggested Setup](#Suggested-Setup)
7. [Attribute Metadata](#Attribute-Metadata)

## Dependencies

   * [ESRI ArcGIS Pro python 3.x](https://pro.arcgis.com/en/pro-app/arcpy/get-started/installing-python-for-arcgis-pro.htm) 
   * [geodatabase-toiler](https://github.com/mattyschell/geodatabase-toiler) on PYTHONPATH


## Import 

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat import.py BUILDING X:\conns\bldg@geocdev.sde\BLDG.BUILDING
```

## Quality Assurance 

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set TARGETLOGDIR=X:\gis\geodatabase-scripts\logs\building_maintain
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat qa.py BUILDING 
```


## Export To GeoJSON

Additional Dependency: 

   * [ogr2ogr](https://gdal.org/programs/ogr2ogr.html) on PATH

Consider repeatedly dumping this file to a drive that supports previous versions
or to somewhere cloudy.

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat export.py BUILDING 
```

## Execute Nightly Maintenance Tasks

1. Update any data that editors don't maintain manually
2. Reconcile and post BUILDING_DOITT_EDIT version to DEFAULT
3. Compress and rebuild geodatabase administrator indexes
4. Rebuild buildings feature class indexes and update database optimizer statistics
5. Run QA on buildings feature class DEFAULT version
6. Notify the squad of QA results

Update the environmental variables at the top of this batch file as needed.

```bat
> sample_maintain.bat 
```

## Suggested Setup

Copy the sample batch files out of geodatabase-buildings\geodatabase-scripts
into a standalone geodatabase-scripts.  Then update variables at the beginning 
of the batch files to match the environment where we are running.

You were expecting containers?  Please.

```
\gis
   \connections
   \geodatabase-buildings
   \geodatabase-scripts
                       \logs
                            \building_maintain.log
                            \qa-BUILDING-yyyymmdd-hhmmss.log
   \geodatabase-toiler        
```

## Attribute Metadata

We maintain these attributes in the geodatabase.  They are, in part, published
as [these attributes](https://github.com/CityOfNewYork/nyc-geo-metadata/blob/master/Metadata/Metadata_BuildingFootprints.md#3-attribute-information).

Here we will document what may be relevant when performing quality assurance
and other automated maintenance tasks. 

| Attribute | Maintenance Notes and Clues | Published As |
|------------ | ------------- | -------- | 
| OBJECTID | Synthetic primary key generated by ESRI Geodatabase. | NA |
| NAME | Unmaintained | NAME |
| BIN | Building Identification Number. Is intended to be unique but in daily maintenance is not. | BIN |
| BASE_BBL | Concatenated borough, block, and lot number for the building's tax lot <br> Multiple buildings can exist on one tax lot. <br> Some are "pseudo bbls," assigned by the Dept. of City Planning for territory not covered by official tax lots.  These have specific values like lot number 9999.  | BASE_BBL  |
| CONSTRUCTION_YEAR | We do not allow year 0 in the geodatabase. NULL is allowed. | CNSTRCT_YR |
| GEOM_SOURCE | Day to day heads-up digitizing, the default, is "Other(manual)" | GEOM_SOURCE |
| LAST_STATUS_TYPE | Set by editors to indicate splits, merges, etc. | LSTSTATTYPE |
| DOITT_ID | Business key trigger-generated from a sequence.  <br> See compiletriggers.sql under the sql directory. <br> New doitt_ids are generated by new records, splits, splits of splits, multisplits, and pastes. | DOITT_ID |
| HEIGHT_ROOF | Current editor protocol is to round to the nearest foot. | HEIGHTROOF |
| FEATURE_CODE | These show as text in the geodatabase but for some reason we publish the numeric code. | FEAT_CODE |
| STATUS | This is the one that exists primarily to interact with Planimetrics? | NA |
| GROUND_ELEVATION | In daily editing this is often input as the mean of the elevations on either side | GROUNDELEV |
| CREATED_USER | Generated by the geodatabase | NA |
| CREATED_DATE | Generated by the geodatabase | NA |
| LAST_EDITED_USER | Generated by the geodatabase <br> Good for QA flagging who is best situated to review an issue | NA |
| LAST_EDITED_DATE | Generated by the geodatabase | NA |
| ADDRESSABLE | Y, N, or NULL. Usually (always) the value is precisely indicated by the feature_code.  | NA |
| MAPPLUTO_BBL | Joins buildings to Boro-Block-Lots in Dept. of City Planning's [MapPLUTO](https://github.com/NYCPlanning/db-pluto) <br> For condos we attempt to use BBLs from the most recently available MapPLUTO release | MPLUTO_BBL |
| CONDO_FLAGS | This column is maintained but has no real purpose. <br> When mappluto_bbl is not equal to base_bbl, this is Y.  | NA |
| ALTERATION_YEAR | Set when the last_status_type is "alteration" but then sticks around. | NA |
| SHAPE | Geometry in http://epsg.io/2263 <br> OGC-valid at .0005 US foot tolerance. <br> No multipart polygons are allowed. <br> No self-overlapping polygons are allowed. <br> Buildings may overlap with other buildings because of cantilevers and overpasses. | SHAPE |




