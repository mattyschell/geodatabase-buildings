# The NYC Buildings Maintenance Toilin'

Code and helpers for maintaining New York City building footprints in a versioned ESRI Enterprise Geodatabase. Friends, this is our NYC buildings footprints in a versioned ESRI Enterprise Geodatabase toil, our rules, the trick is never to be afraid.


# Table of Contents

1. [Dependencies](#Dependencies)
2. [Import](#Import)
3. [Quality Assurance](#Quality-Assurance)
4. [Export To GeoJSON](#Export-To-GeoJSON)
5. [Execute Nightly Maintenance Tasks](#Execute-Nightly-Maintenance-Tasks)
6. [Suggested Setup](#Suggested-Setup)
7. [Attribute Metadata](#Attribute-Metadata)

## Dependencies

   * [ESRI ArcGIS Pro python 3.x](https://pro.arcgis.com/en/pro-app/arcpy/get-started/installing-python-for-arcgis-pro.htm) 
   * [geodatabase-toiler](https://github.com/mattyschell/geodatabase-toiler) on PYTHONPATH


## Import 

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat import.py BUILDING X:\conns\bldg@geocdev.sde\BLDG.BUILDING
```

## Quality Assurance 

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set TARGETLOGDIR=X:\gis\geodatabase-scripts\logs\building_maintain
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat qa.py BUILDING 
```


## Export To GeoJSON

Additional Dependency: 

   * [ogr2ogr](https://gdal.org/programs/ogr2ogr.html) on PATH

Consider repeatedly dumping this file to a drive that supports previous versions
or to somewhere cloudy.

```bat
> set SDEFILE=X:\GIS\Internal\Connections\oracle19c\dev\GIS-ditGSdv1\bldg.sde
> set PYTHONPATH=X:\geodatabase-toiler\src\py;X:\geodatabase-buildings
> c:\Progra~1\ArcGIS\Pro\bin\Python\scripts\propy.bat export.py BUILDING 
```

## Execute Nightly Maintenance Tasks

1. Update any data that editors don't maintain manually
2. Reconcile and post BUILDING_DOITT_EDIT version to DEFAULT
3. Compress and rebuild geodatabase administrator indexes
4. Rebuild buildings feature class indexes and update database optimizer statistics
5. Run QA on buildings feature class DEFAULT version
6. Notify the squad of QA results

Update the environmental variables at the top of this batch file as needed.

```bat
> sample_maintain.bat 
```

## Suggested Setup

Copy the sample batch files out of geodatabase-buildings\geodatabase-scripts
into a standalone geodatabase-scripts.  Then update variables at the beginning 
of the batch files to match the environment where we are running.

You were expecting containers?  Please.

```
\gis
   \connections
   \geodatabase-buildings
   \geodatabase-scripts
                       \logs
                            \building_maintain.log
                            \qa-BUILDING-yyyymmdd-hhmmss.log
   \geodatabase-toiler        
```

## Attribute Metadata

We maintain these attributes in the geodatabase.  Some are published, often under different names and with varying degrees of domain decoding, to NYC Open Data and to the NYCMaps ArcGIS Online organization. Here we will document what may be relevant when performing quality assurance or when attempting to decode published column names.

* [NYC Open Data](https://data.cityofnewyork.us/Housing-Development/Building-Footprints/nqwf-w8eh)
* [NYCMaps ArcGIS Online](https://nyc.maps.arcgis.com/home/item.html?id=870bf69e8a8044aea4488e564c0b4010) 

| Attribute | Maintenance Notes and Clues | NYC Open Data | NYCMaps ArcGIS Online |
|------------ | ------------- | -------- | -------- | 
| OBJECTID | Synthetic primary key generated by ESRI Geodatabase. | NA | NA |
| NAME | Unmaintained | name | Name |
| BIN | Building Identification Number, pronounced "bin" by all  <br> Intended to be unique but in daily maintenance is not | bin | BIN |
| BASE_BBL | Concatenated borough, block, and lot number for the building's tax lot <br> Multiple buildings can exist on one tax lot <br> Some are "pseudo bbls," assigned by the Dept. of City Planning for territory not covered by official tax lots <br> These have specific values like lot number 9999  | base_bbl | Base BBL |
| CONSTRUCTION_YEAR | We do not allow year 0 in the geodatabase <br> NULL is allowed | cnstrct_yr | Construction Year  |
| GEOM_SOURCE | Day to day heads-up digitizing, the default, is "Other(manual)" | geom_source | Geometry Source |
| LAST_STATUS_TYPE | Set by editors to indicate splits, merges, etc | lststattype | NA |
| DOITT_ID | Synthetic business key trigger-generated from a sequence  <br> See compiletriggers.sql under the sql directory <br> New doitt_ids are generated by new records, splits, splits of splits, multisplits, and pastes | doitt_id | DOITT ID |
| HEIGHT_ROOF | Current editor protocol is to round to the nearest foot | heightroof | Height Roof |
| FEATURE_CODE | These are domains, as of May 2023 we publish the codes not the values <br> 1000 = Parking <br> 1001 = Gas Station Canopy <br> 1002 = Storage Tank <br> 1003 = Placeholder <br> 1004 = Auxiliary Structure <br> 1005 = Temporary Structure <br> 1006 = Cantilevered Building <br> 2100 = Building <br> 2110 = Skybridge <br> 5100 = Building Under Construction <br> 5110 = Garage |  feat_code | Feature Code |
| STATUS | This was used some sort of bulk update but is not maintained | NA | NA |
| GROUND_ELEVATION | In daily editing this is often input as the mean of the elevations on either side | groundelev | Ground Elevation |
| CREATED_USER | Generated by the geodatabase | NA | NA |
| CREATED_DATE | Generated by the geodatabase | NA | NA |
| LAST_EDITED_USER | Generated by the geodatabase <br> Good for QA flagging who is best situated to review an issue | NA | NA |
| LAST_EDITED_DATE | Generated by the geodatabase | lstmoddate | NA |
| ADDRESSABLE | Y, N, or NULL, the value is precisely indicated by the feature_code.  | NA | NA |
| MAPPLUTO_BBL | Joins buildings to Boro-Block-Lots in Dept. of City Planning's [MapPLUTO](https://github.com/NYCPlanning/db-pluto) <br> For condos we attempt to use BBLs from the most recently available MapPLUTO release | mpluto_bbl | Map Pluto BBL |
| CONDO_FLAGS | This useless column is not maintained or published <br>  | NA | NA |
| ALTERATION_YEAR | Set when the last_status_type is "alteration" but then sticks around | NA | NA |
| SHAPE | Geometry in http://epsg.io/2263 <br> OGC-valid at .0005 US foot tolerance <br> No multipart polygons are allowed <br> No self-overlapping polygons are allowed <br> Buildings may overlap with other buildings because of cantilevers and overpasses | shape | shape  |
| GLOBALID | Auto-generated [UUID](https://en.wikipedia.org/wiki/Universally_unique_identifier) | globalid | NA |




